<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Journal</title>
    <!-- Load jsPDF and html2canvas from CDN with local fallback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>if (!window.jspdf) { document.write('<script src="./lib/jspdf.umd.min.js"></script>'); }</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>if (!window.html2canvas) { document.write('<script src="./lib/html2canvas.min.js"></script>'); }</script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            font-size: 2rem;
        }
        .search-container {
            max-width: 400px;
            margin: 10px auto;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            outline: none;
        }
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        .main-content {
            display: flex;
            min-height: 500px;
        }
        .sidebar {
            width: 250px;
            background: #f8f9fa;
            padding: 15px;
            border-right: 1px solid #e9ecef;
        }
        .add-entry-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .journal-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .journal-item {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .journal-item:hover {
            background: #f1f3f5;
        }
        .journal-item.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .journal-preview {
            font-size: 12px;
            opacity: 0.7;
        }
        .journal-date {
            font-size: 11px;
            opacity: 0.6;
        }
        .editor-section {
            flex: 1;
            padding: 15px;
            background: white;
        }
        .title-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            margin-bottom: 15px;
        }
        .title-input:focus {
            border-color: #667eea;
        }
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .toolbar button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: white;
        }
        .telegram-btn {
            background: linear-gradient(135deg, #0088cc, #006699);
        }
        .pdf-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        .image-btn {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }
        .textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            outline: none;
        }
        .textarea:focus {
            border-color: #667eea;
        }
        .image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .image-item {
            position: relative;
        }
        .image-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
        .image-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 10px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .save-btn, .delete-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }
        .save-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        .delete-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        .hidden {
            display: none;
        }
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ú® My Personal Journal</h1>
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Search entries...">
                <button class="clear-btn" id="clearBtn">√ó</button>
            </div>
        </div>
        <div class="main-content">
            <div class="sidebar">
                <button class="add-entry-btn" id="addEntryBtn">+ New Entry</button>
                <div class="journal-list" id="journalList"></div>
            </div>
            <div class="editor-section">
                <input type="text" class="title-input" id="titleInput" placeholder="Entry title...">
                <div class="toolbar">
                    <button class="telegram-btn" id="telegramBtn">‚úàÔ∏è Telegram</button>
                    <button class="pdf-btn" id="pdfBtn">üìÑ Download PDF</button>
                    <button class="image-btn" id="imageBtn">üñºÔ∏è Add Image</button>
                </div>
                <div class="content-area">
                    <textarea class="textarea" id="contentTextarea" placeholder="Start writing..."></textarea>
                    <div class="image-container" id="imageContainer"></div>
                    <div class="action-buttons">
                        <button class="save-btn" id="saveBtn">üíæ Save</button>
                        <button class="delete-btn" id="deleteBtn">üóëÔ∏è Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="file" id="imageInput" accept="image/*" multiple class="hidden">

    <script>
        class JournalApp {
            constructor() {
                console.log('Initializing JournalApp');
                this.entries = this.loadEntries();
                this.currentEntryId = null;
                this.currentImages = [];
                this.initializeApp();
            }

            loadEntries() {
                console.log('Loading entries from localStorage');
                try {
                    const stored = localStorage.getItem('journalEntries');
                    if (stored) return JSON.parse(stored);
                } catch (error) {
                    console.error('Error loading entries:', error);
                    this.showMessage('Failed to load entries.', 'error');
                }
                return [{
                    id: Date.now().toString(),
                    title: 'Welcome to Your Journal!',
                    content: 'Start writing your thoughts here.',
                    images: [],
                    date: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                }];
            }

            initializeApp() {
                console.log('Setting up app');
                this.bindEvents();
                this.renderEntries();
                if (this.entries.length > 0) this.loadEntry(this.entries[0].id);
            }

            bindEvents() {
                console.log('Binding event listeners');
                const addEntryBtn = document.getElementById('addEntryBtn');
                const saveBtn = document.getElementById('saveBtn');
                const deleteBtn = document.getElementById('deleteBtn');
                const searchInput = document.getElementById('searchInput');
                const clearBtn = document.getElementById('clearBtn');
                const telegramBtn = document.getElementById('telegramBtn');
                const pdfBtn = document.getElementById('pdfBtn');
                const imageBtn = document.getElementById('imageBtn');
                const imageInput = document.getElementById('imageInput');

                if (!addEntryBtn || !saveBtn || !deleteBtn || !searchInput || !clearBtn || !telegramBtn || !pdfBtn || !imageBtn || !imageInput) {
                    console.error('One or more DOM elements not found');
                    this.showMessage('App initialization failed.', 'error');
                    return;
                }

                addEntryBtn.addEventListener('click', () => {
                    console.log('Add Entry clicked');
                    this.createNewEntry();
                });
                saveBtn.addEventListener('click', () => {
                    console.log('Save clicked');
                    this.saveCurrentEntry();
                });
                deleteBtn.addEventListener('click', () => {
                    console.log('Delete clicked');
                    this.deleteCurrentEntry();
                });
                searchInput.addEventListener('input', (e) => this.searchEntries(e.target.value));
                clearBtn.addEventListener('click', () => {
                    console.log('Clear search clicked');
                    searchInput.value = '';
                    this.renderEntries();
                });
                telegramBtn.addEventListener('click', () => {
                    console.log('Telegram share clicked');
                    this.shareToTelegram();
                });
                pdfBtn.addEventListener('click', () => {
                    console.log('PDF download clicked');
                    this.downloadAsPDF();
                });
                imageBtn.addEventListener('click', () => {
                    console.log('Image upload clicked');
                    imageInput.click();
                });
                imageInput.addEventListener('change', (e) => this.handleImageUpload(e));
            }

            createNewEntry() {
                const newEntry = {
                    id: Date.now().toString(),
                    title: 'Untitled Entry',
                    content: '',
                    images: [],
                    date: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };
                this.entries.unshift(newEntry);
                this.saveEntries();
                this.renderEntries();
                this.loadEntry(newEntry.id);
            }

            saveCurrentEntry() {
                if (!this.currentEntryId) {
                    this.showMessage('No entry selected.', 'error');
                    return;
                }
                const entry = this.entries.find(e => e.id === this.currentEntryId);
                if (!entry) return;
                entry.title = document.getElementById('titleInput').value || 'Untitled Entry';
                entry.content = document.getElementById('contentTextarea').value;
                entry.images = this.currentImages;
                entry.lastModified = new Date().toISOString();
                this.saveEntries();
                this.renderEntries();
                this.showMessage('Entry saved!', 'success');
            }

            deleteCurrentEntry() {
                if (!this.currentEntryId) return;
                if (confirm('Delete this entry?')) {
                    this.entries = this.entries.filter(e => e.id !== this.currentEntryId);
                    this.saveEntries();
                    this.renderEntries();
                    this.clearEditor();
                    if (this.entries.length > 0) this.loadEntry(this.entries[0].id);
                }
            }

            loadEntry(entryId) {
                const entry = this.entries.find(e => e.id === entryId);
                if (!entry) return;
                this.currentEntryId = entryId;
                this.currentImages = [...entry.images];
                document.getElementById('titleInput').value = entry.title;
                document.getElementById('contentTextarea').value = entry.content;
                this.renderImages();
                this.highlightActiveEntry(entryId);
            }

            clearEditor() {
                this.currentEntryId = null;
                this.currentImages = [];
                document.getElementById('titleInput').value = '';
                document.getElementById('contentTextarea').value = '';
                document.getElementById('imageContainer').innerHTML = '';
            }

            renderEntries(filteredEntries = null) {
                const entries = filteredEntries || this.entries;
                const listContainer = document.getElementById('journalList');
                listContainer.innerHTML = entries.map(entry => `
                    <div class="journal-item ${entry.id === this.currentEntryId ? 'active' : ''}" data-id="${entry.id}" onclick="app.loadEntry('${entry.id}')">
                        <div style="font-weight: 600;">${entry.title}</div>
                        <div class="journal-preview">${entry.content.substring(0, 50)}${entry.content.length > 50 ? '...' : ''}</div>
                        <div class="journal-date">${new Date(entry.date).toLocaleDateString()}</div>
                    </div>
                `).join('');
            }

            highlightActiveEntry(entryId) {
                document.querySelectorAll('.journal-item').forEach(item => item.classList.remove('active'));
                const activeItem = document.querySelector(`[data-id="${entryId}"]`);
                if (activeItem) activeItem.classList.add('active');
            }

            searchEntries(query) {
                if (!query.trim()) {
                    this.renderEntries();
                    return;
                }
                const filtered = this.entries.filter(entry =>
                    entry.title.toLowerCase().includes(query.toLowerCase()) ||
                    entry.content.toLowerCase().includes(query.toLowerCase())
                );
                this.renderEntries(filtered);
            }

            handleImageUpload(event) {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;
                files.forEach(file => {
                    if (file.size > 5 * 1024 * 1024) {
                        this.showMessage(`Image ${file.name} too large. Max 5MB.`, 'error');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.currentImages.push({
                            id: Date.now().toString() + Math.random(),
                            data: e.target.result,
                            name: file.name
                        });
                        this.renderImages();
                        this.showMessage('Image added!', 'success');
                    };
                    reader.readAsDataURL(file);
                });
                event.target.value = '';
            }

            renderImages() {
                const container = document.getElementById('imageContainer');
                container.innerHTML = this.currentImages.map(img => `
                    <div class="image-item">
                        <img src="${img.data}" alt="${img.name}">
                        <button class="image-delete" onclick="app.removeImage('${img.id}')">√ó</button>
                    </div>
                `).join('');
            }

            removeImage(imageId) {
                this.currentImages = this.currentImages.filter(img => img.id !== imageId);
                this.renderImages();
            }

            shareToTelegram() {
                try {
                    const entry = this.getCurrentEntryData();
                    if (!entry.title && !entry.content) {
                        this.showMessage('Add content to share.', 'error');
                        return;
                    }
                    const text = `*${entry.title}*\n\n${entry.content}`;
                    const url = `https://t.me/share/url?text=${encodeURIComponent(text)}`;
                    console.log('Telegram URL:', url);
                    const popup = window.open(url, '_blank');
                    if (!popup) {
                        this.showMessage('Pop-up blocked. Allow pop-ups or open URL manually.', 'error');
                    } else {
                        this.showMessage('Opening Telegram...', 'success');
                    }
                } catch (error) {
                    console.error('Telegram share error:', error);
                    this.showMessage('Error sharing to Telegram.', 'error');
                }
            }

            downloadAsPDF() {
                try {
                    console.log('Generating PDF');
                    if (typeof window.jspdf === 'undefined') {
                        this.showMessage('PDF library not loaded.', 'error');
                        return;
                    }
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    const entry = this.getCurrentEntryData();
                    pdf.setFontSize(20);
                    pdf.text(entry.title, 20, 30);
                    pdf.setFontSize(12);
                    pdf.text(`Date: ${new Date(entry.date).toLocaleDateString()}`, 20, 40);
                    pdf.setFontSize(11);
                    const contentLines = pdf.splitTextToSize(entry.content, 170);
                    let yPosition = 50;
                    contentLines.forEach(line => {
                        if (yPosition > 280) {
                            pdf.addPage();
                            yPosition = 20;
                        }
                        pdf.text(line, 20, yPosition);
                        yPosition += 7;
                    });
                    pdf.save(`${entry.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);
                    this.showMessage('PDF downloaded!', 'success');
                } catch (error) {
                    console.error('PDF error:', error);
                    this.showMessage('Error generating PDF.', 'error');
                }
            }

            getCurrentEntryData() {
                return {
                    title: document.getElementById('titleInput').value || 'Untitled Entry',
                    content: document.getElementById('contentTextarea').value,
                    date: this.entries.find(e => e.id === this.currentEntryId)?.date || new Date().toISOString()
                };
            }

            saveEntries() {
                try {
                    localStorage.setItem('journalEntries', JSON.stringify(this.entries));
                } catch (error) {
                    console.error('Error saving entries:', error);
                    this.showMessage('Error saving entries.', 'error');
                }
            }

            showMessage(message, type = 'info') {
                const messageEl = document.createElement('div');
                messageEl.style.cssText = `
                    position: fixed; top: 20px; right: 20px; padding: 10px 20px; border-radius: 6px;
                    color: white; font-weight: 500; z-index: 1000;
                    background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                `;
                messageEl.textContent = message;
                document.body.appendChild(messageEl);
                setTimeout(() => {
                    if (messageEl.parentNode) document.body.removeChild(messageEl);
                }, 3000);
            }
        }

        // Initialize after DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing app');
            window.app = new JournalApp();
        });
    </script>
</body>
</html>
